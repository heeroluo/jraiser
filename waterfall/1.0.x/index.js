/*!
 * JRaiser 2 Javascript Library
 * waterfall - v1.0.0 (2013-11-30T17:43:18+0800)
 * http://jraiser.org/ | Released under MIT license
 */
define("waterfall/1.0.x/",["underscore/1.4.x/","tmpl/1.0.x/","dom/1.0.x/","widget/1.0.x/"],function(e){"use strict";function i(e,i){e.forEach(function(e){e.loaded||e.complete?i():e.onload=function(){this.onload=null,this.loaded=!0,i()}})}var t=(e("base/1.0.x/"),e("underscore/1.4.x/")),r=e("tmpl/1.0.x/"),n=e("dom/1.0.x/"),a=e("widget/1.0.x/"),o=function(){var e,i=document.createElement("div"),t=["Webkit","Moz","O","MS"];if("transition"in i.style)e="";else for(var r=0;r<t.length;r++)if(t[r]+"Transition"in i.style){e=t[r];break}return i=null,e}(),d=o?o+"TransitionDuration":"transitionDuration";return a.create(function(){},{_init:function(e){var i=this,r=e.wrapper,a=r.children();i._loadingPage=e.page||1,a.length||(a=null,i._loadingPage--),i._wrapper=r.css({overflow:"hidden",position:"relative"}),i._gridWidth=e.gridWidth||(a?a.outerWidth():0),i._rowSpacing=e.rowSpacing;var d=r.outerWidth(),s=parseInt(d/i._gridWidth);a&&(a.css("position","absolute"),null!=o&&a.css({left:d-i._gridWidth,right:"auto"})),i._colSpacing=(d-s*i._gridWidth)/(s-1),i._cols=new Array(s);for(var l=i._cols.length-1;l>=0;l--)i._cols[l]=0;if(i._checkMoreTrigger=t.debounce(function(){if(!(i._isDataLoading||i._isImgLoading||i._isEnd)){var t=document.documentElement,n=(t.scrollTop||window.pageYOffset||0)+t.clientHeight,a=r.offset().top,o=r.outerHeight();if(n>=a+o)i.next();else if(e.prefetch&&!i._prefetchedData){var d=o-(/%$/.test(e.prefetch)?parseFloat(e.prefetch,10)/100*o:e.prefetch);n>=a+d&&i._loadNext(!0)}}},50),n(window).on("scroll resize",i._checkMoreTrigger),a){i._isDataLoading=!0,i._renderingPage=1;var g=function(){i.trigger("render",{grids:a,page:i._renderingPage}),i._showGrids(a),i._isDataLoading=!1,a=null};null!=o?setTimeout(g,0):g()}else i._renderingPage=0,e.loadFirstPageOnInit&&i.next()},_destory:function(){var e=this;delete e._wrapper,delete e._gridWidth,delete e._rowSpacing,delete e._colSpacing,delete e._cols,delete e._isImgLoading,delete e._isDataLoading,delete e._isPrefetching,delete e._prefetchedData,delete e._isEnd,delete e._loadingPage,delete e._renderingPage,n(window).off("scroll resize",e._checkMoreTrigger),delete e._checkMoreTrigger},_loadNext:function(e){var i=this;if(!i._isDataLoading&&!i._isEnd){var t=i.trigger("beforeload",{page:i._loadingPage+1,isPrefetch:e});t.isDefaultPrevented()||(i._isDataLoading=!0,i._isPrefetching=e,i._options.load.call(i,++i._loadingPage))}},next:function(){this._prefetchedData?(this._add(this._prefetchedData),delete this._prefetchedData):this._loadNext()},minColIndex:function(){var e=this._cols;if(e){for(var i=0,t=1;t<e.length;t++)e[t]<e[i]&&(i=t);return i}},_showGrids:function(e){var t=this,r=e.find("img"),n=e.length,a=-1,s=function(i){if(null!=i&&i>a){for(var r,s,l=a+1;i>=l;l++)r=t.minColIndex(),s=e.eq(l),null!=o?s.css(d,"1s"):s.css("right","auto"),s.css({top:t._cols[r],left:(t._gridWidth+t._colSpacing)*r}),t._cols[r]+=s.outerHeight()+t._rowSpacing;t.trigger("imageload",{grids:e.slice(a,i)}),a=i,t._wrapper.height(Math.max.apply(Math,t._cols)),i>=n-1&&(t._isImgLoading=!1,t.trigger("allimagesload",{grids:e}),t._checkMoreTrigger())}};t._options.fixedImgSize?s(n-1):(t._isImgLoading=!0,i(r,function(){var i;e.each(function(e,t){if(!(a>=0&&a>=t)){for(var r=!0,n=e.getElementsByTagName("img"),o=n.length-1;o>=0;o--)if(r=r&&(n[o].loaded||n[o].complete),!r)return r;i=t}}),s(i)}))},_add:function(e){var i=this,t=i._cols.length-1,a=r.render(i._options.template,e);if(a){var d=n(a).css("position","absolute");null!=o&&d.css({top:i._cols[t],left:(i._gridWidth+i._colSpacing)*t}),a=null,i._wrapper.append(d),i.trigger("render",{grids:d,page:++i._renderingPage});var s=0;d.forEach(function(){var e=d.outerHeight();e>s&&(s=e)}),i._wrapper.css("height",1.5*(s+i._rowSpacing)+Math.max.apply(Math,i._cols)),i._showGrids(d)}},completeLoading:function(e){var i=this;i.trigger("load",{data:e}),e&&(i._options.isEnd&&i._options.isEnd.call(i,e)?(i._isEnd=!0,i.trigger("end")):i._isPrefetching?(i._prefetchedData=e,i._checkMoreTrigger()):i._add(e)),i._isPrefetching=!1,i._isDataLoading=!1},clear:function(){if(this._wrapper){this._wrapper.empty().css("height",0);for(var e=this._cols.length-1;e>=0;e--)this._cols[e]=0}}},{fixedImgSize:!0,loadFirstPageOnInit:!0,isEnd:function(e){return!e.data||!e.data.length}})});