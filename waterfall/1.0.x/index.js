/*!
 * JRaiser 2 Javascript Library
 * waterfall - v1.0.0 (2013-11-30T17:43:18+0800)
 * http://jraiser.org/ | Released under MIT license
 */
define("waterfall/1.0.x/",["underscore/1.4.x/","tmpl/1.0.x/","dom/1.0.x/","widget/1.0.x/"],function(e,i,t){"use strict";function r(e,i){e.forEach(function(e){e.loaded||e.complete?i():e.onload=function(){this.onload=null,this.loaded=!0,i()}})}var n=(e("base/1.0.x/"),e("underscore/1.4.x/")),a=e("tmpl/1.0.x/"),o=e("dom/1.0.x/"),d=e("widget/1.0.x/"),s=function(){var e,i=document.createElement("div"),t=["Webkit","Moz","O","MS"];if("transition"in i.style)e="";else for(var r=0;r<t.length;r++)if(t[r]+"Transition"in i.style){e=t[r];break}return i=null,e}(),l=s?s+"TransitionDuration":"transitionDuration";return d.create(function(e){},{_init:function(e){var i=this,t=e.wrapper,r=t.children();i._loadingPage=e.page||1,r.length||(r=null,i._loadingPage--),i._wrapper=t.css({overflow:"hidden",position:"relative"}),i._gridWidth=e.gridWidth||(r?r.outerWidth():0),i._rowSpacing=e.rowSpacing;var a=t.outerWidth(),d=parseInt(a/i._gridWidth);r&&(r.css("position","absolute"),null!=s&&r.css({left:a-i._gridWidth,right:"auto"})),i._colSpacing=(a-d*i._gridWidth)/(d-1),i._cols=new Array(d);for(var l=i._cols.length-1;l>=0;l--)i._cols[l]=0;if(i._checkMoreTrigger=n.debounce(function(){if(!(i._isDataLoading||i._isImgLoading||i._isEnd)){var r=document.documentElement,n=(r.scrollTop||window.pageYOffset||0)+r.clientHeight,a=t.offset().top,o=t.outerHeight();if(n>=a+o)i.next();else if(e.prefetch&&!i._prefetchedData){var d=o-(/%$/.test(e.prefetch)?parseFloat(e.prefetch,10)/100*o:e.prefetch);n>=a+d&&i._loadNext(!0)}}},50),o(window).on("scroll resize",i._checkMoreTrigger),r){i._isDataLoading=!0,i._renderingPage=1;var g=function(){i.trigger("render",{grids:r,page:i._renderingPage}),i._showGrids(r),i._isDataLoading=!1,r=null};null!=s?setTimeout(g,0):g()}else i._renderingPage=0,e.loadFirstPageOnInit&&i.next()},_destory:function(){var e=this;delete e._wrapper,delete e._gridWidth,delete e._rowSpacing,delete e._colSpacing,delete e._cols,delete e._isImgLoading,delete e._isDataLoading,delete e._isPrefetching,delete e._prefetchedData,delete e._isEnd,delete e._loadingPage,delete e._renderingPage,o(window).off("scroll resize",e._checkMoreTrigger),delete e._checkMoreTrigger},_loadNext:function(e){var i=this;if(!i._isDataLoading&&!i._isEnd){var t=i.trigger("beforeload",{page:i._loadingPage+1,isPrefetch:e});t.isDefaultPrevented()||(i._isDataLoading=!0,i._isPrefetching=e,i._options.load.call(i,++i._loadingPage))}},next:function(){this._prefetchedData?(this._add(this._prefetchedData),delete this._prefetchedData):this._loadNext()},minColIndex:function(){var e=this._cols;if(e){for(var i=0,t=1;t<e.length;t++)e[t]<e[i]&&(i=t);return i}},_showGrids:function(e){var i=this,t=e.find("img"),n=e.length,a=-1,o=function(t){if(null!=t&&t>a){for(var r,o,d=a+1;t>=d;d++)r=i.minColIndex(),o=e.eq(d),null!=s?o.css(l,"1s"):o.css("right","auto"),o.css({top:i._cols[r],left:(i._gridWidth+i._colSpacing)*r}),i._cols[r]+=o.outerHeight()+i._rowSpacing;i.trigger("imageload",{grids:e.slice(a,t)}),a=t,i._wrapper.height(Math.max.apply(Math,i._cols)),t>=n-1&&(i._isImgLoading=!1,i.trigger("allimagesload",{grids:e}),i._checkMoreTrigger())}};i._options.fixedImgSize?o(n-1):(i._isImgLoading=!0,r(t,function(){var i;e.each(function(e,t){if(!(a>=0&&a>=t)){for(var r=!0,n=e.getElementsByTagName("img"),o=n.length-1;o>=0;o--)if(r=r&&(n[o].loaded||n[o].complete),!r)return r;i=t}}),o(i)}))},_add:function(e){var i=this,t=i._cols.length-1,r=a.render(i._options.template,e);if(r){var n=o(r).css("position","absolute");null!=s&&n.css({top:i._cols[t],left:(i._gridWidth+i._colSpacing)*t}),r=null,i._wrapper.append(n),i.trigger("render",{grids:n,page:++i._renderingPage});var d=0;n.forEach(function(e){var i=n.outerHeight();i>d&&(d=i)}),i._wrapper.css("height",1.5*(d+i._rowSpacing)+Math.max.apply(Math,i._cols)),i._showGrids(n)}},completeLoading:function(e){var i=this;i.trigger("load",{data:e}),e&&(i._options.isEnd&&i._options.isEnd.call(i,e)?(i._isEnd=!0,i.trigger("end")):i._isPrefetching?(i._prefetchedData=e,i._checkMoreTrigger()):i._add(e)),i._isPrefetching=!1,i._isDataLoading=!1},clear:function(){if(this._wrapper){this._wrapper.empty().css("height",0);for(var e=this._cols.length-1;e>=0;e--)this._cols[e]=0}}},{fixedImgSize:!0,loadFirstPageOnInit:!0,isEnd:function(e){return!e.data||!e.data.length}})});