/*!
 * JRaiser 2 Javascript Library
 * waterfall - v1.1.0 (2013-09-28T11:29:46+0800)
 * http://jraiser.org/ | Released under MIT license
 */
define("waterfall/1.1.x/",["dom/1.0.x/","underscore/1.5.x/","tmpl/1.0.x/","ajax/1.1.x/","widget/1.0.x/",null],function(e){"use strict";function i(e,i){e.forEach(function(e){e.loaded||e.complete?i():e.onload=function(){this.onload=null,this.loaded=!0,i()}})}var t=(e("base/1.0.x/"),e("dom/1.0.x/")),n=e("underscore/1.5.x/"),r=e("tmpl/1.0.x/"),a=e("ajax/1.1.x/"),o=e("widget/1.0.x/"),d=function(){var e,i=document.createElement("div"),t=["Webkit","Moz","O","MS"];if("transition"in i.style)e="";else for(var n=0;n<t.length;n++)if(t[n]+"Transition"in i.style){e=t[n];break}return i=null,e}(),s=d?d+"TransitionDuration":"transitionDuration";return o.create(function(){},{_init:function(e){var i=this,r=e.wrapper,a=r.children();i._loadingPage=e.page||1,a.length||(a=null,i._loadingPage--),i._wrapper=r.css({overflow:"hidden",position:"relative"}),i._gridWidth=e.gridWidth||(a?a.outerWidth():0),i._rowSpacing=e.rowSpacing;var o=r.outerWidth(),s=parseInt(o/i._gridWidth);a&&(a.css("position","absolute"),null!=d&&a.css({left:o-i._gridWidth,right:"auto"})),i._colSpacing=(o-s*i._gridWidth)/(s-1),i._cols=new Array(s);for(var g=i._cols.length-1;g>=0;g--)i._cols[g]=0;if(i._checkMoreTrigger=n.debounce(function(){if(!(i._isDataLoading||i._isImgLoading||i._isEnd)){var t=document.documentElement,n=(t.scrollTop||window.pageYOffset||0)+t.clientHeight,a=r.offset().top,o=r.outerHeight();if(n>=a+o)i.next();else if(e.prefetch&&!i._prefetchedData){var d=o-(/%$/.test(e.prefetch)?parseFloat(e.prefetch,10)/100*o:e.prefetch);n>=a+d&&i._loadNext(!0)}}},50),t(window).on("scroll resize",i._checkMoreTrigger),a){i._isDataLoading=!0,i._renderingPage=1;var l=function(){i.trigger("render",{grids:a,page:i._renderingPage}),i._showGrids(a),i._isDataLoading=!1,a=null};null!=d?setTimeout(l,0):l()}else i._renderingPage=0,e.loadFirstPageOnInit&&i.next()},_destory:function(){var e=this;delete e._wrapper,delete e._gridWidth,delete e._rowSpacing,delete e._colSpacing,delete e._cols,delete e._isImgLoading,delete e._isDataLoading,delete e._isPrefetching,delete e._prefetchedData,delete e._isEnd,delete e._loadingPage,delete e._renderingPage,t(window).off("scroll resize",e._checkMoreTrigger),delete e._checkMoreTrigger},_loadNext:function(e){var i=this;if(!i._isDataLoading&&!i._isEnd){var t=i.trigger("beforeload",{page:i._loadingPage+1,isPrefetch:e});t.isDefaultPrevented()||(i._isDataLoading=!0,i._isPrefetching=e,a.send({url:i._options.dataURL,data:{page:++i._loadingPage},dataType:i._options.dataType,onsuccess:function(e){i._completeLoading(e)}}))}},_completeLoading:function(e){var i=this;i.trigger("load",{data:e}),e&&(i._options.isEnd&&i._options.isEnd.call(i,e)?(i._isEnd=!0,i.trigger("end")):i._isPrefetching?(i._prefetchedData=e,i._checkMoreTrigger()):i._add(e)),i._isPrefetching=!1,i._isDataLoading=!1},next:function(){this._prefetchedData?(this._add(this._prefetchedData),delete this._prefetchedData):this._loadNext()},minColIndex:function(){var e=this._cols;if(e){for(var i=0,t=1;t<e.length;t++)e[t]<e[i]&&(i=t);return i}},_showGrids:function(e){var t=this,n=e.find("img"),r=e.length,a=-1,o=function(i){if(null!=i&&i>a){for(var n,o,g=a+1;i>=g;g++)n=t.minColIndex(),o=e.eq(g),null!=d?o.css(s,"1s"):o.css("right","auto"),o.css({top:t._cols[n],left:(t._gridWidth+t._colSpacing)*n}),t._cols[n]+=o.outerHeight()+t._rowSpacing;t.trigger("imageload",{grids:e.slice(a,i)}),a=i,t._wrapper.height(Math.max.apply(Math,t._cols)),i>=r-1&&(t._isImgLoading=!1,t.trigger("allimagesload",{grids:e}),t._checkMoreTrigger())}};t._options.fixedImgSize?o(r-1):(t._isImgLoading=!0,i(n,function(){var i;e.each(function(e,t){if(!(a>=0&&a>=t)){for(var n=!0,r=e.getElementsByTagName("img"),o=r.length-1;o>=0;o--)if(n=n&&(r[o].loaded||r[o].complete),!n)return n;i=t}}),o(i)}))},_add:function(e){var i=this,n=i._cols.length-1,a=r.render(i._options.template,e);if(a){var o=t(a).css("position","absolute");null!=d&&o.css({top:i._cols[n],left:(i._gridWidth+i._colSpacing)*n}),a=null,i._wrapper.append(o),i.trigger("render",{grids:o,page:++i._renderingPage});var s=0;o.forEach(function(){var e=o.outerHeight();e>s&&(s=e)}),i._wrapper.css("height",1.5*(s+i._rowSpacing)+Math.max.apply(Math,i._cols)),i._showGrids(o)}},clear:function(){if(this._wrapper){this._wrapper.empty().css("height",0);for(var e=this._cols.length-1;e>=0;e--)this._cols[e]=0}}},{dataType:"jsonp",fixedImgSize:!0,loadFirstPageOnInit:!0,isEnd:function(e){return!e.data||!e.data.length}})});