/*!
 * JRaiser 2 Javascript Library
 * waterfall - v1.1.1 (2014-06-25T18:06:45+0800)
 * http://jraiser.org/ | Released under MIT license
 */
define("waterfall/1.1.x/",["dom/1.0.x/","underscore/1.5.x/","tmpl/1.0.x/","base/1.1.x/","ajax/1.1.x/","widget/1.0.x/"],function(e,i,t){"use strict";function r(e,i){e.forEach(function(e){if(e.loaded||e.complete)i();else{var t;e.onload=e.onerror=e.onabort=function(){t||(t=!0,this.onload=this.onerror=this.onabort=null,this.loaded=!0,i())}}})}var n=(e("base/1.0.x/"),e("dom/1.0.x/")),a=e("underscore/1.5.x/"),o=e("tmpl/1.0.x/"),s=e("ajax/1.1.x/"),d=e("widget/1.0.x/"),g=function(){var e,i=document.createElement("div"),t=["Webkit","Moz","O","MS"];if("transition"in i.style)e="";else for(var r=0;r<t.length;r++)if(t[r]+"Transition"in i.style){e=t[r];break}return i=null,e}(),l=g?g+"TransitionDuration":"transitionDuration";return d.create(function(e){},{_init:function(e){var i=this,t=e.wrapper,r=t.children();i._loadingPage=e.page||1,r.length||(r=null,i._loadingPage--),i._wrapper=t.css({overflow:"hidden",position:"relative"}),i._gridWidth=e.gridWidth||(r?r.outerWidth():0),i._rowSpacing=e.rowSpacing;var o=t.outerWidth(),s=parseInt(o/i._gridWidth);r&&(r.css("position","absolute"),null!=g&&r.css({left:o-i._gridWidth,right:"auto"})),i._colSpacing=(o-s*i._gridWidth)/(s-1),i._cols=new Array(s);for(var d=i._cols.length-1;d>=0;d--)i._cols[d]=0;if(i._checkMoreTrigger=a.debounce(function(){if(!(i._isDataLoading||i._isImgLoading||i._isEnd)){var r=document.documentElement,n=(r.scrollTop||window.pageYOffset||0)+r.clientHeight,a=t.offset().top,o=t.outerHeight();if(n>=a+o)i.next();else if(e.prefetch&&!i._prefetchedData){var s=o-(/%$/.test(e.prefetch)?parseFloat(e.prefetch,10)/100*o:e.prefetch);n>=a+s&&i._loadNext(!0)}}},50),n(window).on("scroll resize",i._checkMoreTrigger),r){i._isDataLoading=!0,i._renderingPage=1;var l=function(){i.trigger("render",{grids:r,page:i._renderingPage}),i._showGrids(r),i._isDataLoading=!1,r=null};null!=g?setTimeout(l,0):l()}else i._renderingPage=0,e.loadFirstPageOnInit&&i.next()},_destory:function(){var e=this;delete e._wrapper,delete e._gridWidth,delete e._rowSpacing,delete e._colSpacing,delete e._cols,delete e._isImgLoading,delete e._isDataLoading,delete e._isPrefetching,delete e._prefetchedData,delete e._isEnd,delete e._loadingPage,delete e._renderingPage,n(window).off("scroll resize",e._checkMoreTrigger),delete e._checkMoreTrigger},_loadNext:function(e){var i=this;if(!i._isDataLoading&&!i._isEnd){var t=i.trigger("beforeload",{page:i._loadingPage+1,isPrefetch:e});t.isDefaultPrevented()||(i._isDataLoading=!0,i._isPrefetching=e,s.send({url:i._options.dataURL,data:{page:++i._loadingPage},dataType:i._options.dataType,onsuccess:function(e){i._completeLoading(e)}}))}},_completeLoading:function(e){var i=this;i.trigger("load",{data:e}),e&&(i._options.isEnd&&i._options.isEnd.call(i,e)?(i._isEnd=!0,i.trigger("end")):i._isPrefetching?(i._prefetchedData=e,i._checkMoreTrigger()):i._add(e)),i._isPrefetching=!1,i._isDataLoading=!1},next:function(){this._prefetchedData?(this._add(this._prefetchedData),delete this._prefetchedData):this._loadNext()},minColIndex:function(){var e=this._cols;if(e){for(var i=0,t=1;t<e.length;t++)e[t]<e[i]&&(i=t);return i}},_showGrids:function(e){var i=this,t=e.find("img"),n=e.length,a=-1,o=function(t){if(null!=t&&t>a){for(var r,o,s=a+1;t>=s;s++)r=i.minColIndex(),o=e.eq(s),null!=g?o.css(l,"1s"):o.css("right","auto"),o.css({top:i._cols[r],left:(i._gridWidth+i._colSpacing)*r}),i._cols[r]+=o.outerHeight()+i._rowSpacing;i.trigger("imageload",{grids:e.slice(a,t)}),a=t,i._wrapper.height(Math.max.apply(Math,i._cols)),t>=n-1&&(i._isImgLoading=!1,i.trigger("allimagesload",{grids:e}),i._checkMoreTrigger())}};i._options.fixedImgSize?o(n-1):(i._isImgLoading=!0,r(t,function(){var i;e.each(function(e,t){if(!(a>=0&&a>=t)){for(var r=!0,n=e.getElementsByTagName("img"),o=n.length-1;o>=0;o--)if(r=r&&(n[o].loaded||n[o].complete),!r)return r;i=t}}),o(i)}))},_add:function(e){var i=this,t=i._cols.length-1,r=o.render(i._options.template,e);if(r){var a=n(r).css("position","absolute");null!=g&&a.css({top:i._cols[t],left:(i._gridWidth+i._colSpacing)*t}),r=null,i._wrapper.append(a),i.trigger("render",{grids:a,page:++i._renderingPage});var s=0;a.forEach(function(e){var i=a.outerHeight();i>s&&(s=i)}),i._wrapper.css("height",1.5*(s+i._rowSpacing)+Math.max.apply(Math,i._cols)),i._showGrids(a)}},clear:function(){if(this._wrapper){this._wrapper.empty().css("height",0);for(var e=this._cols.length-1;e>=0;e--)this._cols[e]=0}}},{dataType:"jsonp",fixedImgSize:!0,loadFirstPageOnInit:!0,isEnd:function(e){return!e.data||!e.data.length}})});