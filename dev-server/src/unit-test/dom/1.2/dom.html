<!DOCTYPE HTML>
<html>

<head>
	<meta charset="utf-8" />
	<title>单元测试-dom</title>
	<link href="/non-modular/qunit/qunit.css" rel="stylesheet" type="text/css">
</head>

<body>
	<div id="qunit"></div>
	<div id="qunit-fixture"></div>
	<div class="test-node">
		<div class="dom-traversal">
			<span>1</span>
			<span>2</span>
			<span id="dom-traversal-index">3</span>
			<span>4</span>
		</div>
	</div>
	<script src="/non-modular/bowljs/bowl.js"></script>
	<script src="/non-modular/bowl-config.js"></script>
	<script src="/non-modular/qunit/qunit.js"></script>
	<script src="/non-modular/test-utils.js"></script>
	<script>
		require(['dom/1.2/dom', 'base/1.2/base'], function($, base) {
			// dom-data
			QUnit.module( 'dom-data');
			QUnit.test('测试set和get方法', function(assert) {
				var node = $('body');
				assert.equal(node.data('key'), undefined, '测试获取为空的情况');
				node.data('key', 'value');
				assert.equal(node.data('key'), 'value', '测试获取有值的情况');
			});

			QUnit.test('测试remove方法', function(assert) {
				var node = $('body');
				node.data('key1', 'vlaue1');
				node.data('key2', 'value2');
				node.removeData('key1');
				assert.equal(node.data('key1') === undefined && node.data('key2') === 'value2', true, '测试删除某个key');
				node.removeData();
				assert.equal(node.data('key2') === undefined, true, '测试删除所有key');
			});

			// dom-traversal
			QUnit.module('dom-traversal');
			QUnit.test('index', function(assert) {
				assert.equal($('#dom-traversal-index').index(), 2, '测试不传参情况');
				assert.equal($('#dom-traversal-index').index('.dom-traversal span'), 2, '测试传入选择器情况');
				assert.equal($('.dom-traversal span').index($('#dom-traversal-index')), 2, '测试传入节点的情况');
			});
			QUnit.test('children', function(assert) {
				var $children = $('.dom-traversal').children();
				assert.equal($children.length, 4);
			});
			QUnit.test('next', function(assert) {
				var $dom = $('#dom-traversal-index').next();
				assert.equal($dom.index(), 3);
			});
			QUnit.test('nextAll', function(assert) {
				var $first = $('.dom-traversal span')[0];
				assert.equal($($first).nextAll().length, 3);
			});
			QUnit.test('prev', function(assert) {
				var $list = $('.dom-traversal span');
				var $last = $list.last();
				var text = $last.prev()[0].innerHTML;
				assert.equal(text, 3);
			});
			QUnit.test('prevAll', function(assert) {
				var $list = $('.dom-traversal span');
				var $last = $list.last();
				assert.equal($($last).prevAll().length, 3);
			});
			QUnit.test('parent', function(assert) {
				var $dom = $('#dom-traversal-index');
				assert.equal($dom.parent()[0].className, 'dom-traversal');
			});
			QUnit.test('parents', function(assert) {
				var $dom = $('#dom-traversal-index');
				function validation() {
					var node = $dom[0];
					return $dom.parents().every(function(item) {
						node = node.parentNode;
						return node === item;
					});
				}
				assert.equal(validation(), true);
			});
			QUnit.test('siblings', function(assert) {
				function createElement(el) {
					return document.createElement(el);
				}
				var parentNode = createElement('div');
				parentNode.appendChild(createElement('div'));
				parentNode.appendChild(createElement('div'));
				parentNode.appendChild(createElement('div'));
				parentNode.appendChild(createElement('div'));
				var targetNode = createElement('div');
				parentNode.appendChild(targetNode);
				var nodeList = $(targetNode).siblings();
				// 正确个数为4
				assert.equal(nodeList.length, 4);
			});
			QUnit.test('nextUntil & prevUntil', function(assert) {
				var innerHTML = '';
				for (var i = 0; i < 10; i++) {
					innerHTML += '<div class="test' + i + '"></div>';
				}
				innerHTML = '<div>' + innerHTML + '</div>';
				var node = testUtils.parseDOM(innerHTML);
				var $list = $(node).children();
				var $first = $list.first();
				var $last = $list.last();
				assert.equal($first.nextUntil('.test8').length, 8, 'nextUntil测试');
				assert.equal($last.prevUntil('.test1').length, 8, 'prevUntil测试');
			});
			QUnit.test('parentsUntil', function(assert) {
				var innerHTML = '';
				for (var i = 0; i < 5; i++) {
					innerHTML = '<div class="parent' + i + '">' + innerHTML + '</div>';
				}
				var node = testUtils.parseDOM(innerHTML);
				var $parent1 = $(node).find('.parent0');
				assert.equal($parent1.parentsUntil('.parent4').length, 4);
			});

			// dom-attr
			QUnit.module('dom-attr');
			QUnit.test('attr & removeAttr', function(assert) {
				var node = testUtils.parseDOM('<div data-num=1></div>');
				assert.equal($(node).attr('data-num'), 1, 'attr获取');
				$(node).attr('data-num', 2);
				assert.equal($(node).attr('data-num'), 2, 'attr设置');
				$(node).removeAttr('data-num');
				assert.equal($(node).attr('data-num'), undefined, 'removeAttr');
			});
			QUnit.test('prop', function(assert) {
				var node = testUtils.parseDOM('<input type="checkbox" checked="checked" />');
				assert.equal($(node).prop('checked'), true, 'prop获取');
				$(node).prop('checked', false);
				assert.equal($(node).prop('checked'), false, 'prop设置');
				$(node).removeAttr('checked');
				assert.equal($(node).prop('checked'), false, 'removeProp');
			});
			QUnit.test('text', function(assert) {
				var node = testUtils.parseDOM('<div>test</div>');
				var text = $(node).text();
				
				assert.equal(text, 'test', '获取值');
			});
		});
	</script>
</body>

</html>