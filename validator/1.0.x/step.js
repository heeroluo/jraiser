/*!
 * JRaiser 2 Javascript Library
 * validator-step - v1.0.0 (2013-10-06T10:41:35+0800)
 * http://jraiser.org/ | Released under MIT license
 */
define("validator/1.0.x/step",["dom/1.0.x/","ajax/1.1.x/","widget/1.0.x/"],function(e){"use strict";function t(e,t){var i,s,n=[];r.isArray(e)&&(i=e,e={},e[t]=i);for(t in e)for(i=e[t],s=0;s<i.length;s++)null!=i[s]&&n.push({name:t,value:i[s]});return n}var r=e("base/1.0.x/"),i=e("dom/1.0.x/"),s=e("ajax/1.1.x/"),n=e("widget/1.0.x/"),o=0;return n.create(function(){},{_init:function(e){var t=this;if(t._id=++o,t._vOptions={},t._fields=e.fields||[],"string"==typeof t._fields&&(t._fields=t._fields.split(/\s+/)),t._rule=e.rule,"string"==typeof t._rule){var r=[];t._ruleNames=[];var i=t._rule.replace(/(\w+)(?::([^!&|()]+))?/g,function(e,i,s){t._ruleNames.push(i);var n="_helpers_."+i+"(_val_";return s&&(n+=",_refVars_["+(r.push(s)-1)+"]"),n+=")"}),s=new Function("_val_","_refVars_","_helpers_","return "+i+";");i=null,r.length||(r=null),t._rule=function(e,t){return s(e,r,t)}}e.stepDisabled?t.disableStep():t.enableStep()},_destroy:function(){delete this._id,delete this._vOptions,delete this._fields,delete this._rule,delete this._ruleNames,delete this._message,delete this._stepDisabled,delete this._remoteCache},id:function(){return this._id},fields:function(){return this._fields.slice()},isRemote:function(){return!!this._options.remoteURL},stepDisabled:function(){return this._stepDisabled},enableStep:function(){this._stepDisabled=!1},disableStep:function(){this._stepDisabled=!0},syncWithValidator:function(e){this._vOptions=r.extend({},e)},exec:function(e,i,n,o){var l=this;if(l.stepDisabled())return 0;var a=l._ruleNames;if(a)for(var _=a.length-1;_>=0;_--)if(!n[a[_]])throw new Error("not such rule("+a[_]+")");l.trigger("beforevalidate",{elements:e.slice()});var u=this._fields,c=u.length;1===c&&(i=i[u[0]]);var d,f=l._options,h=!0;if(1!==c||f.oneByOne===!1||f.remoteURL){if(1===c&&f.required!==!1&&(h=i.length>0&&""!==i.join("")),h&&l._rule)if(f.remoteURL){var v=function(t){return l._remoteCache=t,l._message=l._rule.call(window,t),l._message?l._error(e.slice(),!0):(l._correct(e.slice(),!0),void(v=null))};if(!o)return l._beforeSend(e.slice()),void s.send(f.remoteURL,r.mix({data:t(i,u[0]),onsuccess:v},f.ajaxSettings||l._vOptions.ajaxSettings,{overwrite:!1}));if("_remoteCache"in l)return v(l._remoteCache)}else{var p;switch(c){case 0:p=[];break;case 1:p=[i.slice()];break;default:p=u.map(function(e){return i[e]?i[e].slice():null})}p.push(n),h=l._rule.apply(window,p),"string"==typeof h&&(l._message=h,h=!1)}h||(d=e.slice())}else if(h=f.required===!1||i.length>0){var d=[];i.every(function(t,r){var i,s=""===t||null==t;if(f.required===!1){if(s)return!0;i=!0}else i=!s;return i&&null!=t&&l._rule&&(i=l._rule.call(window,t,n)),i||d.push(e[r]),h=h&&i,i||!l._vOptions.breakOnError})}else d=e.slice();return h?void l._correct(e.slice()):l._error(d,!0)},_makeEventArg:function(e){return e.stepId=this.id(),this._options.eventElements&&(e.elements=r.toArray(i(e.elements).filter(this._options.eventElements))),e},_beforeSend:function(e){var t=this._makeEventArg({elements:e});return 1==this._options.eventMode&&this._vOptions.beforeSend&&this._vOptions.beforeSend.call(window,t),this.trigger("beforesend",t),t},_error:function(e,t){var r=this._makeEventArg({elements:e,isRemote:!!t,message:this._message||this._options.message});return 1==this._options.eventMode&&this._vOptions.onError&&this._vOptions.onError.call(window,r),this.trigger("error",r),r},_correct:function(e,t){var r=this._makeEventArg({elements:e,isRemote:!!t});return 1==this._options.eventMode&&this._vOptions.onCorrect&&this._vOptions.onCorrect.call(window,r),this.trigger("correct",r),r}},{eventMode:1})});