/*!
 * JRaiser 2 Javascript Library
 * validator-step - v1.0.0 (2013-10-06T10:41:35+0800)
 * http://jraiser.org/ | Released under MIT license
 */
define("validator/1.0.x/step",["dom/1.0.x/","base/1.1.x/","ajax/1.1.x/","widget/1.0.x/"],function(e,t,r){"use strict";function i(e,t){var r,i,n=[];s.isArray(e)&&(r=e,e={},e[t]=r);for(t in e)for(r=e[t],i=0;i<r.length;i++)null!=r[i]&&n.push({name:t,value:r[i]});return n}var s=e("base/1.0.x/"),n=e("dom/1.0.x/"),o=e("ajax/1.1.x/"),l=e("widget/1.0.x/"),a=0;return l.create(function(e){},{_init:function(e){var t=this;if(t._id=++a,t._vOptions={},t._fields=e.fields||[],"string"==typeof t._fields&&(t._fields=t._fields.split(/\s+/)),t._rule=e.rule,"string"==typeof t._rule){var r=[];t._ruleNames=[];var i=t._rule.replace(/(\w+)(?::([^!&|()]+))?/g,function(e,i,s){t._ruleNames.push(i);var n="_helpers_."+i+"(_val_";return s&&(n+=",_refVars_["+(r.push(s)-1)+"]"),n+=")"}),s=new Function("_val_","_refVars_","_helpers_","return "+i+";");i=null,r.length||(r=null),t._rule=function(e,t){return s(e,r,t)}}e.stepDisabled?t.disableStep():t.enableStep()},_destroy:function(e){delete this._id,delete this._vOptions,delete this._fields,delete this._rule,delete this._ruleNames,delete this._message,delete this._stepDisabled,delete this._remoteCache},id:function(){return this._id},fields:function(){return this._fields.slice()},isRemote:function(){return!!this._options.remoteURL},stepDisabled:function(){return this._stepDisabled},enableStep:function(){this._stepDisabled=!1},disableStep:function(){this._stepDisabled=!0},syncWithValidator:function(e){this._vOptions=s.extend({},e)},exec:function(e,t,r,n){var l=this;if(l.stepDisabled())return 0;var a=l._ruleNames;if(a)for(var _=a.length-1;_>=0;_--)if(!r[a[_]])throw new Error("not such rule("+a[_]+")");l.trigger("beforevalidate",{elements:e.slice()});var u=this._fields,c=u.length;1===c&&(t=t[u[0]]);var d,f=l._options,h=!0;if(1!==c||f.oneByOne===!1||f.remoteURL){if(1===c&&f.required!==!1&&(h=t.length>0&&""!==t.join("")),h&&l._rule)if(f.remoteURL){var v=function(t){return l._remoteCache=t,l._message=l._rule.call(window,t),l._message?l._error(e.slice(),!0):(l._correct(e.slice(),!0),void(v=null))};if(!n)return l._beforeSend(e.slice()),void o.send(f.remoteURL,s.mix({data:i(t,u[0]),onsuccess:v},f.ajaxSettings||l._vOptions.ajaxSettings,{overwrite:!1}));if("_remoteCache"in l)return v(l._remoteCache)}else{var p;switch(c){case 0:p=[];break;case 1:p=[t.slice()];break;default:p=u.map(function(e){return t[e]?t[e].slice():null})}p.push(r),h=l._rule.apply(window,p),"string"==typeof h&&(l._message=h,h=!1)}h||(d=e.slice())}else if(h=f.required===!1||t.length>0){var d=[];t.every(function(t,i){var s,n=""===t||null==t;if(f.required===!1){if(n)return!0;s=!0}else s=!n;return s&&null!=t&&l._rule&&(s=l._rule.call(window,t,r)),s||d.push(e[i]),h=h&&s,s||!l._vOptions.breakOnError})}else d=e.slice();return h?void l._correct(e.slice()):l._error(d,!0)},_makeEventArg:function(e){return e.stepId=this.id(),this._options.eventElements&&(e.elements=s.toArray(n(e.elements).filter(this._options.eventElements))),e},_beforeSend:function(e){var t=this._makeEventArg({elements:e});return 1==this._options.eventMode&&this._vOptions.beforeSend&&this._vOptions.beforeSend.call(window,t),this.trigger("beforesend",t),t},_error:function(e,t){var r=this._makeEventArg({elements:e,isRemote:!!t,message:this._message||this._options.message});return 1==this._options.eventMode&&this._vOptions.onError&&this._vOptions.onError.call(window,r),this.trigger("error",r),r},_correct:function(e,t){var r=this._makeEventArg({elements:e,isRemote:!!t});return 1==this._options.eventMode&&this._vOptions.onCorrect&&this._vOptions.onCorrect.call(window,r),this.trigger("correct",r),r}},{eventMode:1})});